<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="/icon.png" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="description" content="Telegram Anonymous Chat" />
  <title>Telegram Anonymous Chat</title>

  <style>
    /* Критические стили для предотвращения белого экрана */
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow-x: hidden;
      background-color: #ffffff;
    }

    #root {
      display: block !important;
      height: 100%;
      width: 100%;
    }

    .loading-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
      background: #ffffff;
      z-index: 9999;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 5px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: #3390ec;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Если загружен телеграм - применим его тему */
    .dark-theme {
      background-color: #212121;
      color: #ffffff;
    }
  </style>

  <!-- Скрипт предварительной загрузки, выполняется сразу -->
  <script type="text/javascript">
    // Определение преференций темы
    function detectColorScheme() {
      var theme = 'light';
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        theme = 'dark';
      }
      // Если доступен Telegram WebApp, используем его тему
      if (window.Telegram && window.Telegram.WebApp) {
        theme = window.Telegram.WebApp.colorScheme || theme;
      }

      document.documentElement.setAttribute('data-theme', theme);
      if (theme === 'dark') {
        document.body.classList.add('dark-theme');
      }
    }

    // Вызываем определение темы сразу
    detectColorScheme();

    // Показываем экран загрузки
    window.addEventListener('DOMContentLoaded', function () {
      var loadingScreen = document.createElement('div');
      loadingScreen.className = 'loading-screen';
      loadingScreen.id = 'app-loading-screen';

      var spinner = document.createElement('div');
      spinner.className = 'loading-spinner';

      var loadingText = document.createElement('p');
      loadingText.textContent = 'Загрузка приложения...';

      loadingScreen.appendChild(spinner);
      loadingScreen.appendChild(loadingText);
      document.body.appendChild(loadingScreen);

      // Вызов WebApp.ready() на раннем этапе
      if (window.Telegram && window.Telegram.WebApp) {
        try {
          window.Telegram.WebApp.ready();
          console.log('✅ WebApp.ready() вызван из раннего скрипта');
        } catch (e) {
          console.warn('❌ Ошибка при раннем вызове WebApp.ready():', e);
        }
      }
    });

    // Функция для удаления экрана загрузки
    window.removeLoadingScreen = function () {
      var loadingScreen = document.getElementById('app-loading-screen');
      if (loadingScreen) {
        loadingScreen.style.opacity = '0';
        loadingScreen.style.transition = 'opacity 0.5s';
        setTimeout(function () {
          if (loadingScreen.parentNode) {
            loadingScreen.parentNode.removeChild(loadingScreen);
          }
        }, 500);
      }
    };

    // Предотвращение белого экрана: вызываем удаление через таймаут
    window.telegramAppInitTimeout = setTimeout(function () {
      window.removeLoadingScreen();
      console.log('⚠️ Экран загрузки удален по таймауту');
    }, 5000); // 5 секунд максимальное время ожидания
  </script>
</head>

<body>
  <div id="root"></div>
  <script type="module" src="/src/main.tsx"></script>
</body>

</html>